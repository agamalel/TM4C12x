// SpaceInvaders.c
// Runs on LM4F120/TM4C123
// Jonathan Valvano and Daniel Valvano
// This is a starter project for the edX Lab 15
// In order for other students to play your game
// 1) You must leave the hardware configuration as defined
// 2) You must not add/remove any files from the project
// 3) You must add your code only this this C file
// I.e., if you wish to use code from sprite.c or sound.c, move that code in this file
// 4) It must compile with the 32k limit of the free Keil

// April 10, 2014
// http://www.spaceinvaders.de/
// sounds at http://www.classicgaming.cc/classics/spaceinvaders/sounds.php
// http://www.classicgaming.cc/classics/spaceinvaders/playguide.php
/* This example accompanies the books
   "Embedded Systems: Real Time Interfacing to Arm Cortex M Microcontrollers",
   ISBN: 978-1463590154, Jonathan Valvano, copyright (c) 2013

   "Embedded Systems: Introduction to Arm Cortex M Microcontrollers",
   ISBN: 978-1469998749, Jonathan Valvano, copyright (c) 2013

 Copyright 2014 by Jonathan W. Valvano, valvano@mail.utexas.edu
    You may use, edit, run or distribute this file
    as long as the above copyright notice remains
 THIS SOFTWARE IS PROVIDED "AS IS".  NO WARRANTIES, WHETHER EXPRESS, IMPLIED
 OR STATUTORY, INCLUDING, BUT NOT LIMITED TO, IMPLIED WARRANTIES OF
 MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE APPLY TO THIS SOFTWARE.
 VALVANO SHALL NOT, IN ANY CIRCUMSTANCES, BE LIABLE FOR SPECIAL, INCIDENTAL,
 OR CONSEQUENTIAL DAMAGES, FOR ANY REASON WHATSOEVER.
 For more information about my classes, my research, and my books, see
 http://users.ece.utexas.edu/~valvano/
 */
// ******* Required Hardware I/O connections*******************
// Slide pot pin 1 connected to ground
// Slide pot pin 2 connected to PE2/AIN1
// Slide pot pin 3 connected to +3.3V 
// fire button connected to PE0
// special weapon fire button connected to PE1
// 8*R resistor DAC bit 0 on PB0 (least significant bit)
// 4*R resistor DAC bit 1 on PB1
// 2*R resistor DAC bit 2 on PB2
// 1*R resistor DAC bit 3 on PB3 (most significant bit)
// LED on PB4
// LED on PB5

// Blue Nokia 5110
// ---------------
// Signal        (Nokia 5110) LaunchPad pin
// Reset         (RST, pin 1) connected to PA7
// SSI0Fss       (CE,  pin 2) connected to PA3
// Data/Command  (DC,  pin 3) connected to PA6
// SSI0Tx        (Din, pin 4) connected to PA5
// SSI0Clk       (Clk, pin 5) connected to PA2
// 3.3V          (Vcc, pin 6) power
// back light    (BL,  pin 7) not connected, consists of 4 white LEDs which draw ~80mA total
// Ground        (Gnd, pin 8) ground

// Red SparkFun Nokia 5110 (LCD-10168)
// -----------------------------------
// Signal        (Nokia 5110) LaunchPad pin
// 3.3V          (VCC, pin 1) power
// Ground        (GND, pin 2) ground
// SSI0Fss       (SCE, pin 3) connected to PA3
// Reset         (RST, pin 4) connected to PA7
// Data/Command  (D/C, pin 5) connected to PA6
// SSI0Tx        (DN,  pin 6) connected to PA5
// SSI0Clk       (SCLK, pin 7) connected to PA2
// back light    (LED, pin 8) not connected, consists of 4 white LEDs which draw ~80mA total

#include <stdlib.h>
#include "tm4c123gh6pm.h"
#include "Nokia5110.h"
#include "Sound.h"
#include "Random.h"
#include "Joystick.h"
#include "TExaS.h"


// *************************** Images ***************************
// enemy ship that starts at the top of the screen (arms/mouth closed)
// width=16 x height=10
const unsigned char SmallEnemy30PointA[] = {
 0x42, 0x4D, 0xC6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x00, 0x01, 0x00, 0x04, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x50, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x80,
 0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x80, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0xC0, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF,
 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x0F, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0xF0, 0xF0, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00,
 0xFF, 0x0F, 0xF0, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x0F, 0xFF, 0xFF, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF};

// enemy ship that starts at the top of the screen (arms/mouth open)
// width=16 x height=10
const unsigned char SmallEnemy30PointB[] = {
 0x42, 0x4D, 0xC6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x00, 0x01, 0x00, 0x04, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x50, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x80,
 0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x80, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0xC0, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF,
 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F,
 0x0F, 0x00, 0x00, 0xF0, 0xF0, 0x00, 0x00, 0x00, 0xF0, 0xFF, 0xFF, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00,
 0xFF, 0x0F, 0xF0, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x0F, 0xFF, 0xFF, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF};

// enemy ship that starts in the middle of the screen (arms together)
// width=16 x height=10
const unsigned char SmallEnemy20PointA[] = {
 0x42, 0x4D, 0xC6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x00, 0x01, 0x00, 0x04, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x50, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x80,
 0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x80, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0xC0, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF,
 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x0F, 0xF0, 0x0F, 0xF0, 0x0F, 0xF0, 0x00, 0x00, 0x00, 0xFF, 0xF0, 0x0F, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0xFF,
 0xF0, 0x0F, 0xF0, 0x0F, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF, 0xF0, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF};

// enemy ship that starts in the middle of the screen (arms apart)
// width=16 x height=10
const unsigned char SmallEnemy20PointB[] = {
 0x42, 0x4D, 0xC6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x00, 0x01, 0x00, 0x04, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x50, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x80,
 0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x80, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0xC0, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF,
 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0xF0,
 0x00, 0x00, 0x00, 0x00, 0x0F, 0xF0, 0x00, 0x0F, 0xF0, 0x0F, 0xF0, 0x0F, 0xF0, 0x00, 0x00, 0x00, 0xFF, 0xF0, 0x0F, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0xFF,
 0xF0, 0x0F, 0xF0, 0x0F, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF, 0xF0, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF};

// enemy ship that starts at the bottom of the screen (arms down)
// width=16 x height=10
const unsigned char SmallEnemy10PointA[] = {
 0x42, 0x4D, 0xC6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x00, 0x01, 0x00, 0x04, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x50, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x80,
 0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x80, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0xC0, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF,
 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x0F, 0xF0, 0x0F, 0xF0, 0x00, 0x00, 0x00, 0xF0, 0xF0, 0x00, 0x00, 0x0F, 0x0F, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x0F,
 0xF0, 0xFF, 0xFF, 0x0F, 0xF0, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF};

// enemy ship that starts at the bottom of the screen (arms up)
// width=16 x height=10
const unsigned char SmallEnemy10PointB[] = {
 0x42, 0x4D, 0xC6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x00, 0x01, 0x00, 0x04, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x50, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x80,
 0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x80, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0xC0, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF,
 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F,
 0x00, 0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x00, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF, 0xF0, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0xFF,
 0xF0, 0xFF, 0xFF, 0x0F, 0xFF, 0x00, 0x00, 0xF0, 0xFF, 0xFF, 0xFF, 0xFF, 0x0F, 0x00, 0x00, 0xF0, 0x0F, 0x00, 0x00, 0xF0, 0x0F, 0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF};

// image of the player's ship
// includes two blacked out columns on the left and right sides of the image to prevent smearing when moved 2 pixels to the left or right
// width=18 x height=8
const unsigned char PlayerShip0[] = {
 0x42, 0x4D, 0xD6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x12, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x01, 0x00, 0x04, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0xC4, 0x0E, 0x00, 0x00, 0xC4, 0x0E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x80,
 0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x80, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0xC0, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF,
 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0x00, 0x00,
 0x00, 0x00, 0x00, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0x00, 0x00, 0x00, 0x00, 0x00, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0A, 0xAA, 0xAA, 0xAA, 0xAA,
 0xAA, 0xA0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0A, 0xAA, 0xA0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0A, 0xAA, 0xA0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0xAA, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF};

// small shield floating in space to cover the player's ship from enemy fire (undamaged)
// width=18 x height=5
const unsigned char Bunker0[] = {
 0x42, 0x4D, 0xB2, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x12, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x01, 0x00, 0x04, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x3C, 0x00, 0x00, 0x00, 0xC4, 0x0E, 0x00, 0x00, 0xC4, 0x0E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x80,
 0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x80, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0xC0, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF,
 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0xAA, 0xAA, 0x00, 0x00, 0x00, 0x00, 0x00, 0xAA, 0xAA, 0x00,
 0x00, 0x00, 0xAA, 0xAA, 0xA0, 0x00, 0x00, 0x00, 0x0A, 0xAA, 0xAA, 0x00, 0x00, 0x00, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0x00, 0x00, 0x00, 0x0A, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA,
 0xAA, 0xAA, 0xA0, 0x00, 0x00, 0x00, 0x00, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0x00, 0x00, 0x00, 0x00, 0xFF};

// small shield floating in space to cover the player's ship from enemy fire (moderate generic damage)
// width=18 x height=5
const unsigned char Bunker1[] = {
 0x42, 0x4D, 0xB2, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x12, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x01, 0x00, 0x04, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x3C, 0x00, 0x00, 0x00, 0xC4, 0x0E, 0x00, 0x00, 0xC4, 0x0E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x80,
 0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x80, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0xC0, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF,
 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0xAA, 0xAA, 0x00, 0x00, 0x00, 0x00, 0x00, 0xAA, 0xAA, 0x00,
 0x00, 0x00, 0xAA, 0xAA, 0xA0, 0x00, 0x00, 0x00, 0x0A, 0xAA, 0x0A, 0x00, 0x00, 0x00, 0x0A, 0x0A, 0xAA, 0xAA, 0xAA, 0xAA, 0xA0, 0xAA, 0xAA, 0x00, 0x00, 0x00, 0x0A, 0xAA, 0x0A, 0xA0, 0xA0, 0xAA,
 0xAA, 0xA0, 0xA0, 0x00, 0x00, 0x00, 0x00, 0x00, 0xA0, 0xA0, 0x00, 0x0A, 0x0A, 0x0A, 0x00, 0x00, 0x00, 0x00, 0xFF};

// small shield floating in space to cover the player's ship from enemy fire (heavy generic damage)
// width=18 x height=5
const unsigned char Bunker2[] = {
 0x42, 0x4D, 0xB2, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x12, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x01, 0x00, 0x04, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x3C, 0x00, 0x00, 0x00, 0xC4, 0x0E, 0x00, 0x00, 0xC4, 0x0E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x80,
 0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x80, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0xC0, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF,
 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x0A, 0x0A, 0x00, 0x00, 0x00, 0x00, 0x00, 0xA0, 0xAA, 0x00,
 0x00, 0x00, 0xAA, 0x0A, 0xA0, 0x00, 0x00, 0x00, 0x0A, 0xAA, 0x0A, 0x00, 0x00, 0x00, 0x0A, 0x0A, 0x0A, 0xA0, 0xAA, 0xA0, 0xA0, 0xA0, 0xA0, 0x00, 0x00, 0x00, 0x00, 0xAA, 0x0A, 0x00, 0xA0, 0xA0,
 0xA0, 0x00, 0xA0, 0x00, 0x00, 0x00, 0x00, 0x00, 0xA0, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF};

// blank space used to cover a bunker that is destroyed
// width=18 x height=5
const unsigned char Bunker3[] = {
 0x42, 0x4D, 0xB2, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x12, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x01, 0x00, 0x04, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x3C, 0x00, 0x00, 0x00, 0xC4, 0x0E, 0x00, 0x00, 0xC4, 0x0E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x80,
 0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x80, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0xC0, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF,
 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF};

// large explosion that can be used upon the demise of the player's ship (first frame)
// width=18 x height=8
const unsigned char BigExplosion0[] = {
 0x42, 0x4D, 0xD6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x12, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x01, 0x00, 0x04, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x80,
 0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x80, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0xC0, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF,
 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x0A, 0x00, 0x09, 0x00, 0x00, 0x00, 0x90, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x90, 0x00, 0x90, 0xB0, 0x0A, 0x00, 0x0B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0B, 0x00, 0x0B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0B, 0xA0, 0x00, 0xE0, 0x00, 0x00,
 0x90, 0x90, 0x9A, 0x00, 0x00, 0x00, 0x00, 0x00, 0xA0, 0x00, 0x00, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x90, 0x00, 0x00, 0xA0, 0x00, 0x00, 0xAE, 0x00, 0x00, 0x00, 0x00, 0x0A, 0x00,
 0x00, 0xE0, 0x0A, 0x0A, 0x00, 0x00, 0xB0, 0x00, 0x00, 0x00, 0xA0, 0x00, 0x09, 0x00, 0x00, 0x00, 0x90, 0x00, 0x0A, 0x00, 0x00, 0x00, 0xFF};

// large explosion that can be used upon the demise of the player's ship (second frame)
// width=18 x height=8
const unsigned char BigExplosion1[] = {
 0x42, 0x4D, 0xD6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x12, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x01, 0x00, 0x04, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x80,
 0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x80, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0xC0, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF,
 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x0E, 0x00, 0x09, 0x00, 0x09, 0x00, 0xB0, 0x00, 0xA0, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x90, 0x00, 0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xA9, 0x00, 0x00, 0x00, 0x00, 0x90,
 0x00, 0x00, 0x0B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0E, 0x00, 0x00, 0x00, 0xA0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x90, 0x00, 0x00, 0x00, 0xE0, 0x00, 0x0A, 0x00, 0x90, 0x00, 0xB0, 0x00, 0x09, 0x00, 0x00, 0x00, 0xFF};

// small explosion best used for the demise of an enemy
// width=16 x height=10
const unsigned char SmallExplosion0[] = {
 0x42, 0x4D, 0xC6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x00, 0x01, 0x00, 0x04, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x50, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x80,
 0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x80, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0xC0, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF,
 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0,
 0x0F, 0x00, 0x0F, 0x00, 0xF0, 0x00, 0x00, 0x0F, 0x00, 0xF0, 0xF0, 0x0F, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x0F, 0xF0, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00,
 0xF0, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x00, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0x00, 0x00, 0x00, 0x0F, 0x00, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF};

// a missile in flight
// includes one blacked out row on the top, bottom, and right of the image to prevent smearing when moved 1 pixel down, up, or left
// width=4 x height=9
const unsigned char Missile0[] = {
 0x42, 0x4D, 0x9A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00, 0x01, 0x00, 0x04, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x80,
 0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x80, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0xC0, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF,
 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x00, 0xF0, 0x00,
 0x00, 0x00, 0x0F, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF};

// a laser burst in flight
// includes one blacked out row on the top and bottom of the image to prevent smearing when moved 1 pixel up or down
// width=2 x height=9
const unsigned char Laser0[] = {
 0x42, 0x4D, 0x9A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00, 0x01, 0x00, 0x04, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x80,
 0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x80, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0xC0, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF,
 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x99, 0x00, 0x00, 0x00, 0xBB, 0x00,
 0x00, 0x00, 0xAA, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF};


// *************************** Capture image dimensions out of BMP**********
#define BUNKERW     			((unsigned char)Bunker0[18])
#define BUNKERH     			((unsigned char)Bunker0[22])
#define ENEMY30W    			((unsigned char)SmallEnemy30PointA[18])
#define ENEMY30H    			((unsigned char)SmallEnemy30PointA[22])
#define ENEMY20W    			((unsigned char)SmallEnemy20PointA[18])
#define ENEMY20H    			((unsigned char)SmallEnemy20PointA[22])
#define ENEMY10W   			  ((unsigned char)SmallEnemy10PointA[18])
#define ENEMY10H    			((unsigned char)SmallEnemy10PointA[22])
#define ENEMYBONUSW 			((unsigned char)SmallEnemyBonus0[18])
#define ENEMYBONUSH 			((unsigned char)SmallEnemyBonus0[22])
#define LASERW      			((unsigned char)Laser0[18])
#define LASERH     				((unsigned char)Laser0[22])
#define MISSILEW    			((unsigned char)Missile0[18])
#define MISSILEH   			  ((unsigned char)Missile0[22])
#define PLAYERW     			((unsigned char)PlayerShip0[18])
#define PLAYERH    				((unsigned char)PlayerShip0[22])
#define FIRE_MOVE_SCALE		((LASERH)/(2))	
#define SHIP_XPOS					18
#define SCALE							24  // 2000/84 POT scale on Nokia so every pixel is 0.024 cm on pot
#define PLAYER						0
#define ENEMY							1
#define PLAYERFIRE_Y			(47 - (PLAYERH) - (BUNKERH))
#define PLAYERFIRE_NUM		16
#define ENEMYNUM 					12
#define RED_LED_ON				(RED_LED | 0x10)
#define BLUE_LED_ON				(BLUE_LED | 0x20)
#define BLUE_LED_OFF			(BLUE_LED & ~0x20)
#define BLUE_LED_TG	    	(BLUE_LED ^ 0x20)
#define FIRE_BUTTON 			(GPIO_PORTE_DATA_R & 0x02)  // PE1
#define RED_LED						(* ((volatile unsigned long  *)0x40024040) ) 	  // PE4 red LED, indicating the game is powered on
#define BLUE_LED					(* ((volatile unsigned long  *)0x40024080) )  	// PE5 Blue LED flashing in the game

typedef struct s {
	unsigned long x;  		// x-axis 
					 long y;			  // y-axis // for moving upward in the player fire state
	const unsigned char *image;	// 
	unsigned long life;
} entity;

entity Enemy[ENEMYNUM]; // maximum number of enemies  
entity PlayerShip;
entity Bunker;
entity EnemyFire[ENEMYNUM];  // shoots(Missile or Laser)
entity PlayerFire[PLAYERFIRE_NUM]; 

void DisableInterrupts(void); // Disable interrupts
void EnableInterrupts(void);  // Enable interrupts
void SysTick_Init(unsigned long Period);
void Switch_Init(void);
void LED_Init(void);

// SysTick Handler is the game engine.
// 30 Hz ADC sampling. 
// sets the sound to play and out them to the headphone.
// interface the switches. 
// activate the LEDs.
// Sets the images and Displays them on the Nokia5110.
void Game_Handler(void); 
void Game_Init(unsigned long Period);
void Delay100ms(unsigned long ); // time delay in 0.1 seconds

// ***** shooter can be the player or the enemy
// ***** 0 for player and 1 for the enemy
// ***** then pick the missile you want
// ***** Create the first to be shooted
void CreateFire(unsigned long Shooter, const unsigned char *FireType);
void CreateImages(void);		// this function creates the sprites in memory
void CreateEnemy(void);
void CreatePlayerShip(void);
void CreateBunker(void);
void DisplayEnemy(void);
void DisplayPlayerShip(void);
void DisplayBunker(void);
void DisplayGame(void);		// this function displays the sprites on the screen
void DisplayFire(void);
void DisplayCollisionSound(void);
void CheckFireCollision(void);
void CheckLevelEnd(void);
void CheckNextLevel(void); // checks if lvl finished 
void ClearShipGun(void); // clears the playership gun when it reached the maxmium (7 shots)
void Move(void);
void CalcScore(void);

extern unsigned char String[10];
extern volatile unsigned long Semaphore;     // 1 means valid Distance, 0 means Distance is empty
unsigned long Digital_Sample;
unsigned long Distance= 1;
unsigned long EnemyKilled, Score, EnemyNum, GameLevel; // game level decides number of enemies and their shape
volatile unsigned long FIRELastState; 
int main(void)
{
  TExaS_Init(SSI0_Real_Nokia5110_Scope);  // set system clock to 80 MHz
  Nokia5110_Init();
  Nokia5110_ClearBuffer();
	Game_Init(2666666);  // 30 Hz, Init Systick, init joystick
	EnableInterrupts();
	Nokia5110_DisplayBuffer();      // draw buffer
	CreateImages(); // create the game images
	DisplayGame();
  while(1)
	{
		while(0 == Semaphore) {}
    FIRELastState= FIRE_BUTTON; // save Fire Button's state before pressing 
		Nokia5110_ClearBuffer();
		DisplayGame();
		Delay100ms(2);
		Semaphore= 0;
  }
}

void SysTick_Init(unsigned long Period)
{
	NVIC_ST_CTRL_R&= 0; // disable Systick while configuring
	NVIC_ST_RELOAD_R= Period - 1;
	NVIC_ST_CURRENT_R= 0; // any write to current clears it
	NVIC_SYS_PRI3_R= (NVIC_SYS_PRI3_R & 0x00FFFFFF) | 0x20000000; // Priority 
	NVIC_ST_CTRL_R|= 0x00000007; // Enable Systick, System Clock and interrupts on
}

void Game_Init(unsigned long Period)
{
	GameLevel= 1;
	EnemyNum= 4;
	Score= 0;
	ADC0_Init(); // ADC0, SS3 highest Priority, 125k sample, Software trigger
	Switch_Init();
	LED_Init();
	RED_LED= RED_LED_ON; // indicate the the circuit connected and working
	BLUE_LED= BLUE_LED_OFF;
	SysTick_Init(Period);
	Sound_Init(); // 11.025 KHz, Timer2
	Nokia5110_SetCursor(0, 0);
	Nokia5110_OutString("Spaceinvaders");
	Nokia5110_SetCursor(0, 1);
	Nokia5110_OutString("By");
	Nokia5110_SetCursor(0, 2);
	Nokia5110_OutString("Mo'meN Ali");
	Nokia5110_SetCursor(0, 3);
	Nokia5110_OutString("Press Fire Button");
	while(!FIRE_BUTTON) {}
}

// only 1 enemy can shoot a missile at a time
unsigned long MoveEnemyFire, LaserNum, ShipXPosition;
void Game_Handler(void)
{	
	Digital_Sample= ADC0_Sample();
	Distance= ADC_Calibration(Digital_Sample); // callibrate it
	//ShipXPosition= Distance / 30; // software Callibration
	ShipXPosition= Distance / 110; // Hardware Callibration
	if(PlayerShip.x < 65 || PlayerShip.x > 18)
	{
		PlayerShip.x= ShipXPosition;
		Bunker.x= ShipXPosition;
	}
	// check if the button pressed and the the player still alive and last shoot is released
	if( FIRE_BUTTON  && PlayerShip.image != BigExplosion0 && !FIRELastState 
			&& PlayerFire[LaserNum].y != PLAYERFIRE_Y)
	{
			CreateFire(PLAYER, Laser0);
	}
	// let Enemy fire every 30Hz
	CreateFire(ENEMY, Missile0);
	CheckFireCollision();
	DisplayCollisionSound();
	Semaphore= 1; // set the semaphoe flag
}

void CreateFire(unsigned long Shooter, const unsigned char *FireType)
{
	unsigned long RandomEnemy= 0; 	
	
	if(PLAYER == Shooter) 
	{
		// check for previous shoot moved enough 
		if(!LaserNum)
		{
			Sound_Shoot();
			// evaluate Laser X-Position
			PlayerFire[LaserNum].x= PlayerShip.x + (PLAYERW / 2) - 1;
			// evaluate Laser Y-Position
			PlayerFire[LaserNum].y= PLAYERFIRE_Y;
			PlayerFire[LaserNum].image= FireType;
			PlayerFire[LaserNum].life= 1;
			++LaserNum;
		}
		else if(PlayerFire[LaserNum - 1].y <= PLAYERFIRE_Y - 8)
		{
			Sound_Shoot();
			// evaluate Laser X-Position
			PlayerFire[LaserNum].x= PlayerShip.x + (PLAYERW / 2) - 1;
			// evaluate Laser Y-Position
			PlayerFire[LaserNum].y= PLAYERFIRE_Y;
			PlayerFire[LaserNum].image= FireType;
			PlayerFire[LaserNum].life= 1;
			++LaserNum;
				
		}
	}
	else if(ENEMY == Shooter)
	{
		// which enemy to shoot ? and evualte its place to put the Missile 
		RandomEnemy= ((Random() >> (31 - EnemyNum)) % EnemyNum);
		if(!EnemyFire[RandomEnemy].life && BigExplosion1 != Enemy[RandomEnemy].image)
		{
			EnemyFire[RandomEnemy].x= Enemy[RandomEnemy].x + ENEMY10W/2;
			EnemyFire[RandomEnemy].y= ENEMY10H + MISSILEH;
			EnemyFire[RandomEnemy].image= FireType;
			EnemyFire[RandomEnemy].life= 1;
		}
	}
}

void DisplayFire(void)
{
	long i;

	// Display and Move the player fired Laser
	for(i= 0; i < LaserNum; ++i)
	{
		// Print each laser
		if(PlayerFire[i].life)
		{
			Nokia5110_PrintBMP(PlayerFire[i].x, PlayerFire[i].y, PlayerFire[i].image, 0);	
		}
		PlayerFire[i].y-= FIRE_MOVE_SCALE; // move the laser
		BLUE_LED= BLUE_LED_TG; // Toggle the blue LED
		if(PlayerFire[i].y < 0) 
		{
			PlayerFire[i].life= 0;
			BLUE_LED= BLUE_LED_OFF;
		}
	}
	if(PlayerFire[15].y < 0)
	{	
		LaserNum&= 0x0F; // reset LaserNum
	}		
	if(!LaserNum)
	{
		ClearShipGun();
	}
	// wait until the last missile goes off the screen
  // clear the previous missiless
	// Count after Displaying is essential for not overrunning the array elements of PlayerFire[4]
	// enemy is firing all the time, so display the enemy's fire and move it continously
	for(i= 0; i < ENEMYNUM; ++i) // check the enemies who have shoots
	{
		if(Enemy[i].life && PlayerShip.life && EnemyFire[i].life && SmallExplosion0 != Enemy[i].image)
		{
		   Nokia5110_PrintBMP(EnemyFire[i].x, EnemyFire[i].y , EnemyFire[i].image, 0);
			 EnemyFire[i].y+= FIRE_MOVE_SCALE/2;	
		}
		if(EnemyFire[i].y > 48)
		{			
			EnemyFire[i].life= 0; // check if EnemyFire's reached the end
		}
	}
}

void CheckFireCollision(void)
{
	long BunkerY1Pos, BunkerX1Pos, PlayerShipX1Pos, PlayerShipY1Pos; 
	long EnemyY1Pos[16]= {0}, EnemyX1Pos[16]= {0}, i, j;
	
	BunkerY1Pos= BunkerX1Pos= PlayerShipX1Pos= PlayerShipY1Pos= 0;
/*** check Enemy shoots hitted or not ***/
	// Evaluate Bunker boundary on the screen
	// Evulate height and width
	BunkerY1Pos= Bunker.y - BUNKERH;
	BunkerX1Pos= Bunker.x + BUNKERW + 2;
	// Evaluate boundary for player ship
	// Evulate height and width
	PlayerShipY1Pos= PlayerShip.y - PLAYERH; 
	PlayerShipX1Pos= PlayerShip.x + PLAYERW;
	// check if there's still a Bunker points left
	if(Bunker.image != Bunker3)
	{
		for(i= 0; i < EnemyNum; ++i)
		{
			if(EnemyFire[i].image) 
			{
				if(EnemyFire[i].x <= BunkerX1Pos && EnemyFire[i].x >= Bunker.x)
				{	
					// now check they meets in any column
					if(EnemyFire[i].y >= BunkerY1Pos && EnemyFire[i].y <= Bunker.y)
					{
						// check bunker health state
						if(Bunker.image == Bunker0)		 
						{		
							EnemyFire[i].image= 0;
							Bunker.image= Bunker1;
							Sound_Fastinvader1();
						}
						else if(Bunker.image == Bunker1)
						{				
							EnemyFire[i].image= 0;
							Bunker.image= Bunker2;
							Sound_Fastinvader2();
						}
						else if(Bunker.image == Bunker2)
						{				
							EnemyFire[i].image= 0;
							Bunker.image= Bunker3;
							Sound_Fastinvader3();
						}
					}
				}
			}
		}
	}
	// else check if the ship got hitted
	else
	{		
		for(i= 0; i < EnemyNum; ++i)
		{
			if(EnemyFire[i].y >= PlayerShipY1Pos && EnemyFire[i].y <= PlayerShip.y 
													&& EnemyFire[i].image && BigExplosion1 != PlayerShip.image) 
			{
				if(EnemyFire[i].x >= PlayerShip.x && EnemyFire[i].x <= PlayerShipX1Pos)
				{
					EnemyFire[i].life= 0;
					PlayerFire[i].life= 0;
					PlayerShip.image= BigExplosion0; // player got shooted and killed
				}
			}
		}
	}
	
	/*** Check player shoots on enemy hitted or missed ***/
	// check enemy killed by the player
	for(i= 0; i < LaserNum; ++i)
	{
		for(j= 0; j < EnemyNum; ++j)
		{
			  // evaulate X & Y dimensions of enemy ship
				EnemyY1Pos[j]= Enemy[j].y + ENEMY10H;
				EnemyX1Pos[j]= Enemy[j].x + ENEMY10W;
			if(PlayerFire[i].y >= Enemy[j].y && PlayerFire[i].y <= EnemyY1Pos[j] 
								&& Enemy[j].life && PlayerFire[i].life && SmallExplosion0 != Enemy[j].image)
			{
				if(PlayerFire[i].x >= Enemy[j].x && PlayerFire[i].x <= EnemyX1Pos[j])
				{
					Enemy[j].image= SmallExplosion0;
					Enemy[j].life= 0;
					EnemyFire[j].life= 0;
					PlayerFire[i].life= 0;
					++EnemyKilled;
				}
			}
		}
	}
}

void DisplayGame(void)
{ 
	DisplayEnemy();
	DisplayPlayerShip();
	DisplayBunker();
	DisplayFire();
	Nokia5110_DisplayBuffer();
	CheckLevelEnd();
}

void DisplayCollisionSound(void)
{
	long i;
	
	for(i= 0; i < EnemyNum; ++i)
	{
			if(SmallExplosion0 == Enemy[i].image && !Enemy[i].life)
			{
				Sound_Killed();
				Enemy[i].life= 1;
			}
	}
	if(BigExplosion0 == PlayerShip.image)
	{
		Sound_Explosion();
		PlayerShip.life= 0;
	}
}

void CalcScore(void)
{
	if(1 == GameLevel)
	{
		Score= EnemyKilled * 10;
	}
	else if(2 == GameLevel)
	{
		Score= Score + (EnemyKilled * 20);
	}		
	else if(3 == GameLevel)
	{
		Score= Score + (EnemyKilled * 30);
	}
}

void CheckLevelEnd(void)
{
	if(EnemyKilled == EnemyNum && PlayerShip.life)
	{
		BLUE_LED= BLUE_LED_OFF;
		Nokia5110_Clear();
		ClearShipGun();
		Nokia5110_SetCursor(0, 0);
		switch(GameLevel)
		{
			case 1:
				Nokia5110_OutString("Level 1");
				Nokia5110_SetCursor(0, 1);
				Nokia5110_OutString("Finished");
				Nokia5110_SetCursor(0, 2);
				CalcScore();
				Nokia5110_OutString("Score");
				Nokia5110_OutUDec(Score);
				Nokia5110_SetCursor(0, 3);
				Nokia5110_OutString("Press start  Button");
				while(!FIRE_BUTTON) {}	
				Delay100ms(2);
				EnemyNum= 8; // setup enemies for level 2
				EnemyKilled= 0;
				++GameLevel; // go to the next level
				CreateEnemy(); // create second level enemies
				break;
			case 2:
				Nokia5110_OutString("Level 2");
				Nokia5110_SetCursor(0, 1);
				Nokia5110_OutString("Finished");
				Nokia5110_OutUDec(Score);
				CalcScore();
				Nokia5110_OutUDec(Score);
				Nokia5110_SetCursor(0, 3);
				Nokia5110_OutString("Press start Button");
				EnemyNum= 12; // setup enemies for level 3
				EnemyKilled= 0;
				++GameLevel;
			  while(1) {}
			/*case 3:
				Nokia5110_OutString("Game Finished");
				Nokia5110_SetCursor(0, 1);
				Nokia5110_OutString("EARTHLING");
				CalcScore();
				Nokia5110_SetCursor(0, 3);
				Nokia5110_OutString("Final Score:");
				Nokia5110_SetCursor(0, 4);
				Nokia5110_OutUDec(Score);
				while(1) {} // Game Finished */
		}
	}		
	else if(!PlayerShip.life || BigExplosion0 == PlayerShip.image)
	{
		BLUE_LED= BLUE_LED_OFF;
		Nokia5110_OutString("HERE");
		ClearShipGun();
		CalcScore();
		Nokia5110_Clear();
		Nokia5110_ClearBuffer();
		PlayerShip.image= BigExplosion1;
		Nokia5110_PrintBMP(PlayerShip.x, PlayerShip.y, PlayerShip.image, 0);
		Nokia5110_DisplayBuffer();
		Nokia5110_SetCursor(0, 0);
		Nokia5110_OutString("You Lost");
		Nokia5110_SetCursor(0, 1);
		Nokia5110_OutString("Score: ");
		Nokia5110_OutUDec(Score);
		while(1) {}
	}
}

void CreatePlayerShip(void)
{
		PlayerShip.x= 0;
		PlayerShip.y= 47;
		PlayerShip.image= PlayerShip0;
		PlayerShip.life= 1;
}

void CreateBunker(void)
{
		Bunker.x= PlayerShip.x;
		Bunker.y= 47 - PLAYERH;
		Bunker.image= Bunker0;
		Bunker.life= 1;
}

void CreateImages(void)
{
		CreateEnemy();
		CreatePlayerShip();
		CreateBunker();
}
	
void CreateEnemy(void)
{
	// all enemies are the same width and hieghts
	long i, EnemyHieght= ENEMY10H, EnemyWidth= 3;
	
	// which level
	if(1 == GameLevel)
	{
		Enemy[0].x= 3;
		Enemy[0].y= ENEMY10H;
		Enemy[0].image= SmallEnemy10PointA; // create random 10 points enemy only
		Enemy[0].life= 1;
	
		Enemy[1].x= Enemy[0].x + ENEMY10W + 3;
		Enemy[1].y= ENEMY10H;
		Enemy[1].image= SmallEnemy10PointB;
		Enemy[1].life= 1;
	
		Enemy[2].x= Enemy[1].x + ENEMY10W + 3;
		Enemy[2].y= ENEMY10H;
		Enemy[2].image= SmallEnemy10PointA;
		Enemy[2].life= 1;
	
		Enemy[3].x= Enemy[2].x + ENEMY10W + 3;
		Enemy[3].y= ENEMY10H;
		Enemy[3].image= SmallEnemy10PointB;
		Enemy[3].life= 1;
	}
	else if(2 == GameLevel)
	{
		for(i= 0; i < EnemyNum; i+= 4, EnemyHieght+= ENEMY10H, EnemyWidth+= 4)
		{
			Enemy[i].x= EnemyWidth;
			Enemy[i].y= EnemyHieght;
			Enemy[i].image= SmallEnemy20PointA; // create random 10 points enemy only
			Enemy[i].life= 1;
			Enemy[i + 1].x= Enemy[i].x + ENEMY10W + 3;
			Enemy[i + 1].y= EnemyHieght;
			Enemy[i + 1].image= SmallEnemy20PointB;
			Enemy[i + 1].life= 1;
			Enemy[i + 2].x= Enemy[i + 1].x + ENEMY10W + EnemyWidth;
			Enemy[i + 2].y= EnemyHieght;
			Enemy[i + 2].image= SmallEnemy20PointA;
			Enemy[i + 2].life= 1;
			Enemy[i + 3].x= Enemy[i + 2].x + ENEMY10W + 3;
			Enemy[i + 3].y= EnemyHieght;
			Enemy[i + 3].image= SmallEnemy20PointB;
			Enemy[i + 3].life= 1;
		}
	}
	else if(3 == GameLevel)	
	{		
		for(i= 0; i < EnemyNum; i+= 4, EnemyHieght+= ENEMY10H, EnemyWidth+= 4)
		{
			Enemy[i].x= EnemyWidth;
			Enemy[i].y= EnemyHieght;
			Enemy[i].image= SmallEnemy30PointA; // create random 10 points enemy only
			Enemy[i].life= 1;
			Enemy[i + 1].x= Enemy[i].x + ENEMY10W + EnemyWidth;
			Enemy[i + 1].y= EnemyHieght;
			Enemy[i + 1].image= SmallEnemy30PointB;
			Enemy[i + 1].life= 1;
			Enemy[i + 2].x= Enemy[i + 1].x + ENEMY10W + EnemyWidth;
			Enemy[i + 2].y= EnemyHieght;
			Enemy[i + 2].image= SmallEnemy30PointA;
			Enemy[i + 2].life= 1;
			Enemy[i + 3].x= Enemy[i + 2].x + ENEMY10W + EnemyWidth;
			Enemy[i + 3].y= EnemyHieght;
			Enemy[i + 3].image= SmallEnemy30PointB;
			Enemy[i + 3].life= 1;
		}
	}
}

void DisplayEnemy(void)
{
	long i;
	
	for(i= 0; i < EnemyNum; i+= 4)
	{
		if(SmallExplosion0 == Enemy[i].image || Enemy[i].life)
		{
			Nokia5110_PrintBMP(Enemy[i].x, Enemy[i].y, Enemy[i].image, 0);
		}
		if(SmallExplosion0 == Enemy[i + 1].image || Enemy[i + 1].life)
		{
			Nokia5110_PrintBMP(Enemy[i + 1].x, Enemy[i + 1].y, Enemy[i + 1].image, 0);
		}
		if(SmallExplosion0 == Enemy[i + 2].image || Enemy[i + 2].life)
		{
			Nokia5110_PrintBMP(Enemy[i + 2].x, Enemy[i + 2].y, Enemy[i + 2].image, 0);
		}
		if(SmallExplosion0 == Enemy[i + 3].image || Enemy[i + 3].life)
		{
			Nokia5110_PrintBMP(Enemy[i + 3].x, Enemy[i + 3].y, Enemy[i + 3].image, 0);
		}
	}
}
	
void DisplayPlayerShip(void)
{
	if(PlayerShip.life > 0)
	{
		Nokia5110_PrintBMP(PlayerShip.x, PlayerShip.y, PlayerShip.image, 0);
	}
}

void DisplayBunker(void)
{
	if(Bunker.life > 0)
	{	
		Nokia5110_PrintBMP(Bunker.x, Bunker.y, Bunker.image, 0);
	}
}
	
void Switch_Init(void)
{
	// Considering PORTE is already initialized by the ADC Module (ADC_Init())
	
	GPIO_PORTE_AFSEL_R&= ~0x02; // PE1
	GPIO_PORTE_AMSEL_R&= ~0x02;
	GPIO_PORTE_DEN_R|= 0x02;    // PE1 digital
	GPIO_PORTE_DIR_R&= ~0x02;   // PE1 input
}

void LED_Init(void)
{
	// LEDs are PE4, PE5
	GPIO_PORTE_AMSEL_R&= ~0x30;
	GPIO_PORTE_AFSEL_R&= ~0x30; // disable alternate function on PD6-PD7
	GPIO_PORTE_DEN_R|= 0x30; // PE4-PE5 digital 
 	GPIO_PORTE_DIR_R|= 0x30; // PE4-PE5 output
}


void ClearShipGun(void)
{
		for(; LaserNum < PLAYERFIRE_NUM; ++LaserNum)
		{
			PlayerFire[LaserNum].image= 0;
			PlayerFire[LaserNum].life= 0;	
		}
		LaserNum= 0;
}	

void Delay100ms(unsigned long count)
{
	unsigned long  time;
  
	while(count>0)
	{
    time = 727240;  // 0.1sec at 80 MHz
    while(time)
		{
	  	time--;
    }
    count--;
  }
}
